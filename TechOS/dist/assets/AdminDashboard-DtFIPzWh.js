import{c as _,e as Z,r as o,j as e,s as ee,v as L,S as je,f as g,u as pe,d as ge,a as Ne}from"./index-BioLNpht.js";import{B as p}from"./button-CybwPT74.js";import{C as ye,a as we,b as be,d as ve}from"./card-D2slsvxv.js";import{S as N}from"./skeleton-DApMEAu8.js";import{T as K,a as Q,b as F,c as j,d as W,e as f}from"./table-BRZz4VyP.js";import{B as Se}from"./badge-DzC7Yn4c.js";import{T as Ce,D as Fe,a as Ie,b as Te,c as Ue,d as Ee}from"./dialog-QflogPSs.js";import{b as ke,F as Le,C as Me,o as Re,s as E,e as De,u as qe,t as Ae}from"./types-eghP_0fx.js";import{L as _e}from"./label-UCsqN31L.js";import{I as k}from"./input-BycZl0OU.js";import{S as Pe,a as Oe,b as Be,c as $e,d as A}from"./select-CCdqiMsy.js";import{L as ze}from"./LanguageSwitcher-H7VO2T-d.js";import{U as He}from"./user-QFrJga9n.js";import{U as X}from"./users-DgMxD1IR.js";import{B as Ve}from"./book-open-BYvQYvA9.js";import{P as Ge}from"./plus-C78Rl13V.js";import"./Combination-BBo_YeSU.js";import"./chevron-down-dB8tcOpH.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=_("ChartNoAxesColumnIncreasing",[["line",{x1:"12",x2:"12",y1:"20",y2:"10",key:"1vz5eb"}],["line",{x1:"18",x2:"18",y1:"20",y2:"4",key:"cun8e5"}],["line",{x1:"6",x2:"6",y1:"20",y2:"16",key:"hq0ia6"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=_("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=_("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]),Qe=({users:r,isLoading:n,onEdit:t,onRefresh:l})=>{const{toast:i}=Z(),[c,d]=o.useState(null),m=async s=>{if(confirm("¿Estás seguro de que quieres eliminar este usuario? Esta acción no se puede deshacer.")){d(s);try{const{error:x}=await ee.functions.invoke("delete-user",{body:{userId:s}});if(x)throw x;i({title:"Éxito",description:"Usuario eliminado correctamente."}),l()}catch(x){i({title:"Error al eliminar",description:x.message||"No se pudo eliminar el usuario",variant:"destructive"})}finally{d(null)}}},C=s=>{switch(s){case"admin":return"destructive";case"teacher":return"default";case"student":return"secondary";case"representative":return"outline";default:return"secondary"}},a=s=>{switch(s){case"admin":return"Admin";case"teacher":return"Teacher";case"student":return"Student";case"representative":return"Representative";default:return s}};return n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(N,{className:"h-8 w-48"}),e.jsx(N,{className:"h-10 w-24"})]}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(K,{children:[e.jsx(Q,{children:e.jsxs(F,{children:[e.jsx(j,{children:"Name"}),e.jsx(j,{children:"Email"}),e.jsx(j,{children:"Role"}),e.jsx(j,{children:"Actions"})]})}),e.jsx(W,{children:[...Array(5)].map((s,x)=>e.jsxs(F,{children:[e.jsx(f,{children:e.jsx(N,{className:"h-4 w-32"})}),e.jsx(f,{children:e.jsx(N,{className:"h-4 w-40"})}),e.jsx(f,{children:e.jsx(N,{className:"h-4 w-16"})}),e.jsx(f,{children:e.jsx(N,{className:"h-8 w-16"})})]},x))})]})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Users (",r.length,")"]}),e.jsxs(p,{onClick:l,variant:"outline",size:"sm",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(K,{children:[e.jsx(Q,{children:e.jsxs(F,{children:[e.jsx(j,{children:"Name"}),e.jsx(j,{children:"Email"}),e.jsx(j,{children:"Role"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(W,{children:r.length===0?e.jsx(F,{children:e.jsx(f,{colSpan:4,className:"text-center py-8 text-muted-foreground",children:"No users found"})}):r.map(s=>e.jsxs(F,{children:[e.jsxs(f,{className:"font-medium",children:[s.first_name," ",s.last_name]}),e.jsx(f,{children:s.email||"No email"}),e.jsx(f,{children:e.jsx(Se,{variant:C(s.role),children:a(s.role)})}),e.jsx(f,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(p,{onClick:()=>t(s),variant:"ghost",size:"sm",children:e.jsx(Ke,{className:"h-4 w-4"})}),e.jsx(p,{onClick:()=>m(s.id),variant:"ghost",size:"sm",disabled:c===s.id,children:c===s.id?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):e.jsx(Ce,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})},We=Le,se=o.createContext({}),I=({...r})=>e.jsx(se.Provider,{value:{name:r.name},children:e.jsx(Me,{...r})}),M=()=>{const r=o.useContext(se),n=o.useContext(te),{getFieldState:t,formState:l}=ke(),i=t(r.name,l);if(!r)throw new Error("useFormField should be used within <FormField>");const{id:c}=n;return{id:c,name:r.name,formItemId:`${c}-form-item`,formDescriptionId:`${c}-form-item-description`,formMessageId:`${c}-form-item-message`,...i}},te=o.createContext({}),w=o.forwardRef(({className:r,...n},t)=>{const l=o.useId();return e.jsx(te.Provider,{value:{id:l},children:e.jsx("div",{ref:t,className:L("space-y-2",r),...n})})});w.displayName="FormItem";const b=o.forwardRef(({className:r,...n},t)=>{const{error:l,formItemId:i}=M();return e.jsx(_e,{ref:t,className:L(l&&"text-destructive",r),htmlFor:i,...n})});b.displayName="FormLabel";const v=o.forwardRef(({...r},n)=>{const{error:t,formItemId:l,formDescriptionId:i,formMessageId:c}=M();return e.jsx(je,{ref:n,id:l,"aria-describedby":t?`${i} ${c}`:`${i}`,"aria-invalid":!!t,...r})});v.displayName="FormControl";const Xe=o.forwardRef(({className:r,...n},t)=>{const{formDescriptionId:l}=M();return e.jsx("p",{ref:t,id:l,className:L("text-sm text-muted-foreground",r),...n})});Xe.displayName="FormDescription";const S=o.forwardRef(({className:r,children:n,...t},l)=>{const{error:i,formMessageId:c}=M(),d=i?String(i==null?void 0:i.message):n;return d?e.jsx("p",{ref:l,id:c,className:L("text-sm font-medium text-destructive",r),...t,children:d}):null});S.displayName="FormMessage";const Ye=Re({firstName:E().min(1,"First name is required"),lastName:E().min(1,"Last name is required"),email:E().email("Invalid email address"),password:E().min(6,"Password must be at least 6 characters").optional(),role:De(["teacher","student","representative"])}),Ze=({open:r,onClose:n,user:t,institutionId:l,onSuccess:i})=>{const{toast:c}=Z(),d=!!t,m=qe({resolver:Ae(Ye),defaultValues:{firstName:"",lastName:"",email:"",password:"",role:"student"}});o.useEffect(()=>{t?m.reset({firstName:t.first_name,lastName:t.last_name,email:t.email||"",role:t.role}):m.reset({firstName:"",lastName:"",email:"",password:"",role:"student"})},[t,m]);const C=async a=>{try{if(d){const{error:s}=await g.from("profiles").update({first_name:a.firstName,last_name:a.lastName,email:a.email,role:a.role}).eq("id",t.id);if(s)throw s;c({title:"Success",description:"User updated successfully"})}else{const{data:s,error:x}=await ee.functions.invoke("create-user",{body:{email:a.email,password:a.password||"",firstName:a.firstName,lastName:a.lastName,role:a.role,institutionId:l}});if(x)throw x;c({title:"Success",description:"User created successfully"})}i(),n()}catch(s){c({title:"Error",description:s.message||`Failed to ${d?"update":"create"} user`,variant:"destructive"})}};return e.jsx(Fe,{open:r,onOpenChange:n,children:e.jsxs(Ie,{className:"sm:max-w-[500px]",children:[e.jsxs(Te,{children:[e.jsx(Ue,{children:d?"Edit User":"Add New User"}),e.jsx(Ee,{children:d?"Update the user information below":"Fill in the details to create a new user"})]}),e.jsx(We,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(C),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{control:m.control,name:"firstName",render:({field:a})=>e.jsxs(w,{children:[e.jsx(b,{children:"First Name"}),e.jsx(v,{children:e.jsx(k,{...a})}),e.jsx(S,{})]})}),e.jsx(I,{control:m.control,name:"lastName",render:({field:a})=>e.jsxs(w,{children:[e.jsx(b,{children:"Last Name"}),e.jsx(v,{children:e.jsx(k,{...a})}),e.jsx(S,{})]})})]}),e.jsx(I,{control:m.control,name:"email",render:({field:a})=>e.jsxs(w,{children:[e.jsx(b,{children:"Email"}),e.jsx(v,{children:e.jsx(k,{type:"email",...a,disabled:d})}),e.jsx(S,{})]})}),!d&&e.jsx(I,{control:m.control,name:"password",render:({field:a})=>e.jsxs(w,{children:[e.jsx(b,{children:"Password"}),e.jsx(v,{children:e.jsx(k,{type:"password",...a})}),e.jsx(S,{})]})}),e.jsx(I,{control:m.control,name:"role",render:({field:a})=>e.jsxs(w,{children:[e.jsx(b,{children:"Role"}),e.jsxs(Pe,{onValueChange:a.onChange,value:a.value,children:[e.jsx(v,{children:e.jsx(Oe,{children:e.jsx(Be,{placeholder:"Select a role"})})}),e.jsxs($e,{children:[e.jsx(A,{value:"teacher",children:"Teacher"}),e.jsx(A,{value:"student",children:"Student"}),e.jsx(A,{value:"representative",children:"Representative"})]})]}),e.jsx(S,{})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(p,{type:"button",variant:"outline",onClick:n,children:"Cancel"}),e.jsx(p,{type:"submit",disabled:m.formState.isSubmitting,children:m.formState.isSubmitting?d?"Updating...":"Creating...":d?"Update User":"Create User"})]})]})})]})})},gs=()=>{const{signOut:r,user:n}=pe(),t=ge(),{t:l}=Ne(),[i,c]=o.useState({totalTeachers:0,totalStudents:0,totalCourses:0,attendanceToday:0}),[d,m]=o.useState([]),[C,a]=o.useState(""),[s,x]=o.useState(!0),[re,P]=o.useState(!0),[ae,R]=o.useState(!1),[ne,D]=o.useState(null),[O,B]=o.useState(null);o.useEffect(()=>{n&&(ie(),$(),z())},[n]);const ie=async()=>{try{const{data:h,error:u}=await g.from("profiles").select("institution_id").eq("id",n==null?void 0:n.id).single();if(u)throw u;a(h.institution_id)}catch(h){console.error("Error fetching institution:",h)}},$=async()=>{x(!0),B(null);try{const{count:h,error:u}=await g.from("profiles").select("*",{count:"exact",head:!0}).eq("role","teacher");if(u)throw u;const{count:q,error:U}=await g.from("profiles").select("*",{count:"exact",head:!0}).eq("role","student");if(U)throw U;const{count:me,error:V}=await g.from("courses").select("*",{count:"exact",head:!0});if(V)throw V;const he=new Date().toISOString().split("T")[0],{data:y,error:G}=await g.from("attendance_records").select("status").eq("date",he);if(G)throw G;const J=(y==null?void 0:y.length)||0,xe=(y==null?void 0:y.filter(fe=>fe.status==="present").length)||0,ue=J>0?Math.round(xe/J*100):0;c({totalTeachers:h||0,totalStudents:q||0,totalCourses:me||0,attendanceToday:ue})}catch(h){console.error("Error fetching dashboard stats:",h),B("Failed to load dashboard statistics")}finally{x(!1)}},z=async()=>{P(!0);try{const{data:h,error:u}=await g.from("profiles").select("id, first_name, last_name, email, role").order("created_at",{ascending:!1});if(u)throw u;m(h||[])}catch(h){console.error("Error fetching users:",h)}finally{P(!1)}},oe=async()=>{await r(),t("/login")},le=()=>{D(null),R(!0)},ce=h=>{D(h),R(!0)},de=()=>{R(!1),D(null)},H=()=>{z(),$()},T=({title:h,value:u,icon:q,isLoading:U})=>e.jsxs(ye,{children:[e.jsxs(we,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(be,{className:"text-sm font-medium",children:h}),e.jsx(q,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(ve,{children:U?e.jsx(N,{className:"h-8 w-20"}):e.jsx("div",{className:"text-2xl font-bold",children:u})})]});return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card",children:e.jsxs("div",{className:"container mx-auto flex h-16 items-center justify-between px-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:l("adminDashboard")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ze,{}),e.jsx(p,{onClick:()=>t("/profile"),variant:"ghost",size:"icon",children:e.jsx(He,{className:"h-5 w-5"})}),e.jsx(p,{onClick:oe,variant:"outline",children:l("signOut")})]})]})}),e.jsxs("main",{className:"container mx-auto p-6 space-y-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-foreground mb-2",children:"Dashboard Overview"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Monitor your institution's key metrics"}),O&&e.jsx("div",{className:"mb-6 rounded-lg bg-destructive/10 p-4 text-destructive",children:O}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(T,{title:"Total Teachers",value:i.totalTeachers,icon:X,isLoading:s}),e.jsx(T,{title:"Total Students",value:i.totalStudents,icon:X,isLoading:s}),e.jsx(T,{title:"Active Courses",value:i.totalCourses,icon:Ve,isLoading:s}),e.jsx(T,{title:"Attendance Today",value:`${i.attendanceToday}%`,icon:Je,isLoading:s})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"User Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage users in your institution"})]}),e.jsxs(p,{onClick:le,children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"}),"Add New User"]})]}),e.jsx(Qe,{users:d,isLoading:re,onEdit:ce,onRefresh:H})]})]}),e.jsx(Ze,{open:ae,onClose:de,user:ne,institutionId:C,onSuccess:H})]})};export{gs as default};
